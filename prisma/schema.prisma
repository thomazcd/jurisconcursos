// Prisma Schema – Juris Concursos (v2: 3 trilhas, dados ricos no precedente)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GESTOR
  USER
}

enum Track {
  PROCURADOR
  JUIZ_FEDERAL
  JUIZ_ESTADUAL
}

enum TrackScope {
  COMMON
  PROCURADOR
  JUIZ_FEDERAL
  JUIZ_ESTADUAL
}

enum Court {
  STF
  STJ
  TRF
  TJ
}

// Applicability agora é multi-trilha: campos booleanos no Precedent
// Mantemos um campo GERAL + 3 booleanos de trilha

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile UserProfile?
  reads   PrecedentRead[]

  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  activeTrack Track    @default(JUIZ_ESTADUAL)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Subject {
  id              String     @id @default(cuid())
  name            String
  trackScope      TrackScope @default(COMMON) // mantido para compatibilidade
  forProcurador   Boolean    @default(false)
  forJuizFederal  Boolean    @default(false)
  forJuizEstadual Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  precedents Precedent[]

  @@map("subjects")
}

model Precedent {
  id            String   @id @default(cuid())
  court         Court
  title         String
  summary       String   @db.Text
  fullTextOrLink String?  @db.Text

  // Aplicabilidade multi-trilha
  forAll        Boolean  @default(true)   // GERAL – aparece para todos
  forProcurador Boolean  @default(false)
  forJuizFederal Boolean @default(false)
  forJuizEstadual Boolean @default(false)

  subjectId     String

  // Dados ricos para o admin / estudo avançado
  judgmentDate  DateTime? // data do julgamento
  publicationDate DateTime? // data de publicação (DJEN/DJe)

  isRG          Boolean   @default(false) // Repercussão Geral
  rgTheme       Int?      // número do tema de RG
  informatoryNumber String? // número do informativo (ex: "1123")
  informatoryYear   Int?      // ano do informativo (ex: 2026)

  processClass  String?   // ex: RE, ADI, REsp
  processNumber String?   // ex: "593.068/SP"
  organ         String?   // ex: "Plenário", "2ª Turma"
  rapporteur    String?   // nome do relator
  theme         String?   // tema (ex: "Tema 1081")
  tags          String[]  @default([])

  // NOVOS CAMPOS PARA FLASHCARDS
  flashcardQuestion String? @db.Text    // A afirmação para o usuário julgar
  flashcardAnswer   Boolean @default(true) // Se a afirmação é V (true) ou F (false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subject Subject         @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  reads   PrecedentRead[]

  @@index([subjectId])
  @@index([court])
  @@index([judgmentDate])
  @@index([forAll])
  @@map("precedents")
}

model PrecedentRead {
  userId      String
  precedentId String
  readCount   Int      @default(0)
  readEvents  DateTime[] @default([])
  
  // NOVOS CAMPOS DE PERFORMANCE
  correctCount Int      @default(0)
  wrongCount   Int      @default(0)
  lastResult   String?  // 'HIT' ou 'MISS'

  isFavorite   Boolean  @default(false)

  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  precedent Precedent @relation(fields: [precedentId], references: [id], onDelete: Cascade)

  @@id([userId, precedentId])
  @@index([userId, precedentId])
  @@map("precedent_reads")
}
